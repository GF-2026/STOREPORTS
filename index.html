<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mantenimiento Preventivo</title>
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--accent:#2b6cb0;--muted:#6b7280}
    body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:24px;color:#0f172a}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:10px;padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:16px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=text],input[type=number],input[type=datetime-local],select,textarea{width:100%;padding:10px;border:1px solid #e6eef6;border-radius:6px;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:0;padding:10px 12px;border-radius:8px;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #cfe0f5}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left;vertical-align:middle}
    th{background:#f1f7fb;color:#0b2235}
    .checkboxes{display:flex;flex-direction:column;gap:6px}
    .fullwidth{grid-column:1/-1}
    .muted{color:var(--muted);font-size:13px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,#e6f0fb,#dbeefe);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700">AV</div>
      <div>
        <h1>REPORTE DE PREVENTIVO</h1>
        <div class="muted">Llena el formulario y presiona "Guardar registro". Luego usa "Exportar a Excel" para agregar el registro a tu historial.</div>
      </div>
    </header>
    
    <form id="reportForm" class="card">
      <!-- DATOS GENERALES -->
      <div class="section-header">
        <div class="muted">Campos obligatorios marcados con *</div>
        <strong>1 ‚Äì Datos de cliente</strong>
        <div><label>Report *</label><input type="text" id="report" value="Mantenimiento preventivo" required /></div>   
      </div>
      <div class="grid">        
        <div><label>PO:</label><input type="text" id="PO"/></div>
        <div><label>OT: *</label><input type="text" id="OT" required /></div>
        <div><label>Fecha y Hora *</label><input type="datetime-local" id="datetime" required /></div>      
        <div><label>Compania</label><input type="text" id="company" /></div>
        <div><label>Ingeniero a cargo</label><input type="text" id="engineer" /></div>
        <div><label>Telefono</label><input type="text" id="phone" /></div>
        <div><label>Ciudad</label><input type="text" id="city" /></div>
      </div>

      <hr />

      <!-- EQUIPO -->
      <div class="section-header"><strong>2 ‚Äì Datos del equipo</strong></div>
      <div class="grid">
        <div><label>Description</label><input type="text" id="description" /></div>
        <div><label>Brand</label><input type="text" id="brand" /></div>
        <div><label>Model</label><input type="text" id="model" /></div>
        <div><label>Serial</label><input type="text" id="serial" /></div>
        <div><label>Control number</label><input type="text" id="controlnum" /></div>
        <div><label>Status</label><input type="text" id="status" /></div>
      </div>

      <hr />

      <!-- AMBIENTE CIRCUNDANTE -->
      <div class="section-header"><strong>3 ‚Äì Condiciones ambientales</strong></div>
      <div class="grid">
       <div class="fullwidth"><label>Ubicacion</label><input type="text" id="ubication" /></div>
       <div><label>Temperatura (¬∞C)</label><input type="number" step="0.1" id="temperature" /></div>
       <div><label>Humedad (%)</label><input type="number" step="0.1" id="humidity" /></div>
      </div>

      <hr />

      <!-- CHECKLIST -->
      <div class="section-header"><strong>4 ‚Äì Checklist</strong></div>
      <div class="grid">
        <div class="checkboxes">
          <label><input type="checkbox" id="shock_free" />Est√° libre de golpes</label>
          <label><input type="checkbox" id="specs_available" />Especificaciones disponibles</label>
          <label><input type="checkbox" id="manuals" />Manuales disponibles</label>        
          <label><input type="checkbox" id="refrigerant" />Refrigerante cargado</label>
          <label><input type="checkbox" id="voltage_plate" />Voltaje coincide con placa</label>
          <label><input type="checkbox" id="supplies_installed" />Suministros instalados</label>
        </div>
      </div>

      <hr />

      <!-- MEDICIONES -->
      <div class="section-header"><strong>5 ‚Äì Mediciones el√©ctricas</strong></div>
      <div class="grid">
        <div><label>Presi√≥n est√°tica LS</label><input type="number" step="0.01" id="static_ls" /></div>
        <div><label>Presi√≥n est√°tica HS</label><input type="number" step="0.01" id="static_hs" /></div>
        <div><label>Resistencia (Œ©)</label><input type="number" step="0.001" id="resistance" /></div>
        <div><label>CompresorLS T1‚ÄìT2 (V)</label><input type="number" step="0.1" id="t1_t2" /></div>
        <div><label>CompresorLS T1‚ÄìT3 (V)</label><input type="number" step="0.1" id="t1_t3" /></div>
        <div><label>CompresorLS T2‚ÄìT3 (V)</label><input type="number" step="0.1" id="t2_t3" /></div>
        <div><label>CompresorLS To ground (V)</label><input type="number" step="0.01" id="to_ground" /></div>
      </div>

      <hr />

      <!-- OBSERVACIONES -->
      <div class="section-header"><strong>6 ‚Äì Observaciones</strong></div>
      <textarea id="notes"></textarea>

      <hr />
      <!-- FIRMA -->
      <div class="section-header"><strong>7 ‚Äì Firma del responsable</strong></div>
      <div class="fullwidth" style="text-align:center">
        <label>Firma manuscrita:</label><br>
        <button type="button" id="openSignature" class="secondary">Abrir firma</button>
        <div style="margin-top:8px">
          <img id="signaturePreview" style="max-width:200px;border:1px solid #ccc;border-radius:6px;display:none" />
        </div>
      </div>

      <!-- MODAL DE FIRMA -->
      <div id="signatureModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999">
        <div style="background:#fff;padding:20px;border-radius:10px;max-width:90%;width:400px;text-align:center">
          <h3>Firma</h3>
          <canvas id="signatureCanvas" width="350" height="200" style="border:1px solid #ccc;border-radius:6px;background:#fff"></canvas>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
            <button type="button" id="clearSignature" class="secondary">Limpiar</button>
            <button type="button" id="saveSignature">Aceptar</button>
            <button type="button" id="closeSignature" class="secondary">Cancelar</button>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button type="button" id="saveBtn">Guardar registro</button>
        <button type="button" class="secondary" id="clearBtn">Limpiar formulario</button>
      </div>
    </form>

    <!-- TABLA -->
    <div class="card">
      <div class="section-header">
        <strong>Registros capturados</strong>
        <div class="actions">
          <button id="exportBtn">Exportar a Excel</button>
          <button class="secondary" id="downloadCsvBtn">Exportar CSV</button>
          <button class="secondary" id="deleteAllBtn">üóëÔ∏è Borrar registros</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="recordsTable">
          <thead><tr id="tableHead"></tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let records = JSON.parse(localStorage.getItem('records') || '[]');

    const columns = [
      'report','datetime','company','engineer','phone','city','ubication',
      'description','brand','model','serial','controlnum','status',
      'temperature','humidity',
      'specs_available','voltage_plate','manuals','refrigerant','shock_free','supplies_installed',
      'static_ls','static_hs','resistance','t1_t2','t1_t3','t2_t3','to_ground',
      'notes','signature'
    ];

    const get = id => document.getElementById(id).value;
    const chk = id => document.getElementById(id).checked ? 'YES' : 'NO';

    function getFormData(){
      return {
        report:get('report'), datetime:get('datetime'), company:get('company'), engineer:get('engineer'),
        phone:get('phone'), city:get('city'), ubication:get('ubication'),
        description:get('description'), brand:get('brand'), model:get('model'),
        serial:get('serial'), controlnum:get('controlnum'), status:get('status'),
        temperature:get('temperature'), humidity:get('humidity'),
        specs_available:chk('specs_available'), voltage_plate:chk('voltage_plate'),
        manuals:chk('manuals'), refrigerant:chk('refrigerant'), shock_free:chk('shock_free'),
        supplies_installed:chk('supplies_installed'),
        static_ls:get('static_ls'), static_hs:get('static_hs'), resistance:get('resistance'),
        t1_t2:get('t1_t2'), t1_t3:get('t1_t3'), t2_t3:get('t2_t3'), to_ground:get('to_ground'),
        notes:get('notes'),
        signature: document.getElementById('signaturePreview').src || ''
      };
    }

    function addRecord(){
      const data = getFormData();
      if(!data.report || !data.datetime){ alert('Completa los campos obligatorios.'); return; }
      records.push(data);
      localStorage.setItem('records', JSON.stringify(records));
      renderTable();
      alert('Registro guardado correctamente.');
    }

    function clearForm(){ document.getElementById('reportForm').reset(); document.getElementById('signaturePreview').style.display='none'; }

    function renderTable(){
      const head = document.getElementById('tableHead');
      const body = document.getElementById('tableBody');
      head.innerHTML = ''; body.innerHTML = '';
      columns.forEach(c=>{
        const th=document.createElement('th'); th.textContent=c.replace(/_/g,' '); head.appendChild(th);
      });
      records.forEach(r=>{
        const tr=document.createElement('tr');
        columns.forEach(c=>{
          const td=document.createElement('td');
          if(c==='signature' && r[c]){
            const img=document.createElement('img');
            img.src=r[c]; img.style.width='100px'; img.style.border='1px solid #ccc'; img.style.borderRadius='4px';
            td.appendChild(img);
          } else {
            td.textContent=r[c]||'';
          }
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    }

    function exportCSV(){
      if(records.length===0){alert('No hay registros.');return;}
      const rows=[columns.join(',')];
      records.forEach(r=>{
        const vals=columns.map(c=>{
          const v=String(r[c]||'').replace(/"/g,'""');
          return v.includes(',')?`"${v}"`:v;
        });
        rows.push(vals.join(','));
      });
      const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='reportes_validacion.csv';
      a.click();
    }

    function exportXLSX(){
      if(records.length===0){alert('No hay registros.');return;}
      if(typeof XLSX==='undefined'){alert('No se pudo cargar Excel, se descargar√° CSV.');return exportCSV();}
      const ws_data=[columns];
      records.forEach(r=>ws_data.push(columns.map(c=>r[c]||'')));
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb,ws,'Reportes');
      XLSX.writeFile(wb,'reportes_validacion.xlsx');
    }

    function deleteAllRecords(){
      if(confirm('¬øSeguro que deseas borrar todos los registros?')){
        records=[];
        localStorage.removeItem('records');
        renderTable();
      }
    }

    // --- Modal de firma ---
    const openBtn = document.getElementById('openSignature');
    const modal = document.getElementById('signatureModal');
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    openBtn.onclick = () => modal.style.display = 'flex';
    document.getElementById('closeSignature').onclick = () => modal.style.display = 'none';

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches && e.touches[0]) {
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      } else {
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      }
    }

    function startDraw(e){ drawing = true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
    function draw(e){
      if(!drawing) return;
      e.preventDefault();
      const p = getPos(e);
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#000';
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
    }
    function stopDraw(){ drawing = false; ctx.beginPath(); }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);
    canvas.addEventListener('touchstart', startDraw);
    canvas.addEventListener('touchmove', draw);
    canvas.addEventListener('touchend', stopDraw);
    canvas.addEventListener('touchcancel', stopDraw);

    document.getElementById('clearSignature').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);

    document.getElementById('saveSignature').onclick = () => {
      const dataURL = canvas.toDataURL();
      const img = document.getElementById('signaturePreview');
      img.src = dataURL;
      img.style.display = 'block';
      modal.style.display = 'none';
    };

    // --- Inicializaci√≥n ---
    (function loadSheetJS(){
      const s=document.createElement('script');
      s.src='https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js';
      document.head.appendChild(s);
    })();

    document.getElementById('saveBtn').onclick=addRecord;
    document.getElementById('clearBtn').onclick=clearForm;
    document.getElementById('exportBtn').onclick=exportXLSX;
    document.getElementById('downloadCsvBtn').onclick=exportCSV;
    document.getElementById('deleteAllBtn').onclick=deleteAllRecords;

    renderTable();
  </script>
</body>
</html>
